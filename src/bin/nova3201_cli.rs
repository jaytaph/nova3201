use nova3201::Machine;

const HELLO_WORLD_PRG: [u32; 21] = [
    // ------------------------------------------------------------
    // r1 = UART_TX (0x8000_2200)
    // ------------------------------------------------------------
    0x5820_8000, // LUI  r1, 0x8000
    0x4821_2200, // ORI  r1, r1, 0x2200
    // ------------------------------------------------------------
    // r2 = pointer to string at address 0x0000_0080
    // ------------------------------------------------------------
    0x5840_0000, // LUI  r2, 0x0000
    0x4842_0038, // ORI  r2, r2, 0x0080
    // ------------------------------------------------------------
    // LOOP:
    // ------------------------------------------------------------
    0x6862_0000, // LB   r3, 0(r2)
    0x8003_0003, // BEQ  r3, r0, +3 (jump to HALT)
    0x6C61_0000, // SB   r3, 0(r1)
    0x4042_0001, // ADDI r2, r2, 1
    0xA000_0004, // J    to instruction index 4 (LB)
    // ------------------------------------------------------------
    // END:
    // ------------------------------------------------------------
    0xFC00_0000, // HALT
    // ------------------------------------------------------------
    // Padding to reach 0x80
    // ------------------------------------------------------------
    0x0000_0000, // (fill)
    0x0000_0000,
    0x0000_0000,
    0x0000_0000,
    // ------------------------------------------------------------
    // DATA SECTION at address 0x00000038
    // ------------------------------------------------------------
    0x6C6C_6568, // "hell"
    0x6F77_206F, // "o wo"
    0x2064_6C72, // "rld "
    0x6D6F_7266, // "from"
    0x766F_6E20, // " nov"
    0x3032_3361, // "a320"
    0x0000_0A31, // "1\n\0\0"];
];

fn main() {
    let mut mach = Machine::new();

    println!("Loading program...");
    mach.load_program(0x0000_0000, &HELLO_WORLD_PRG);

    // // Memory dump
    // println!("Memory dump at 0x00000000:");
    // for i in 0..12 {
    //     let addr = 0x0000_0000 + (i * 16);
    //     let word1 = mach.bus.read32(addr + 0).unwrap();
    //     let word2 = mach.bus.read32(addr + 4).unwrap();
    //     let word3 = mach.bus.read32(addr + 8).unwrap();
    //     let word4 = mach.bus.read32(addr + 12).unwrap();
    //     println!("0x{:08X}: 0x{:08X} 0x{:08X} 0x{:08X} 0x{:08X}", addr, word1, word2, word3, word4);
    // }

    for _ in 0..10_000 {
        mach.step();
        if mach.cpu.halted {
            println!("CPU halted.");
            break;
        }
    }
}
